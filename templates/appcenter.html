{% extends "base.html" %}

{% block content %}

<div id="appcenter-area">
    <div class="tabs" role="tablist">
        <input type="radio" title="Installed" name="tab-state" id="installed" role="tab" checked />
        <input type="radio" title="Presentations" name="tab-state" id="presentations" role="tab" />
        <input type="radio" title="Addons" name="tab-state" id="addons" role="tab" />

        <label for="installed" id="installed-tab" class="tab">Installed</label>
        <label for="presentations" id="presentations-tab" class="tab">Presentations</label>
        <label for="addons" id="addons-tab" class="tab">Addons</label>
        <button style="float: right; margin: 2rem 3rem 0 0" disabled="disabled">Install from file</button>


        {# ------------------------------------------------------------------ #}
        {# Installed #}
        {# ------------------------------------------------------------------ #}
        <div id="installed-panel" class="panel active" role="tabpanel">
            {% if installed_presentation %}
            <div id="active-app-area" class="area">
                
                <img src="{{installed_presentation.preview_image}}" />
                <div id="active-app-description">
                    <span class="current-app">Current presentation</span>
                    <h1>{{installed_presentation.prettyname}}</h1>
                    <p>
                        Version {{installed_presentation.candidate.version}}<br/>
                        By <a href="{{installed_presentation.candidate.homepage}}">{{installed_presentation.maintainer}}</a>
                    </p>
                    <span>{{installed_presentation.candidate.summary}}</span>
                    <p>
                        <button onclick="uninstall('{{installed_presentation.shortname}}', '{{installed_presentation.name}}')">Remove</button>
                        {% if installed_presentation.has_settings %}
                        <button onclick="document.location='/appsettings';">Settings</button>
                        {% endif %}
                    </p>
              </div>
            </div>
            {% endif %}

            <div class="area">
                <h2>Addons</h2>
                {% for package in available_packages.addons if package.is_installed %}
                <div class="app">
                    <img class="preview-image" src="{{package.preview_image}}" />
                    <div class="info-area">
                        <div class="info">
                            <strong class="name">{{package.prettyname}}</strong>
                            <span class="developer">By <a href="{{package.candidate.homepage}}">{{package.maintainer}}</a></span>
                            <div class="description">{{package.candidate.summary}}</div>
                            {% if package.is_installed %}
                                <button onclick="uninstall('{{package.shortname}}', '{{package.name}}')">Remove</button>
                            {% else %}
                                <button onclick="install('{{package.shortname}}', '{{package.name}}')">Install</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>

        {# ------------------------------------------------------------------ #}
        {# Presentations #}
        {# ------------------------------------------------------------------ #}
        <div id="presentations-panel" class="panel area" role="tabpanel">
            {% for package in available_packages.presentations %}
            <div class="app{% if package.is_installed %} installed{% endif %}">
                <img class="preview-image" src="{{package.preview_image}}" />
                <div class="info-area">
                    <div class="info">
                        <strong class="name">{{package.prettyname}}</strong>
                        <span class="developer">By <a href="{{package.candidate.homepage}}">{{package.maintainer}}</a></span>
                        <div class="description">{{package.candidate.summary}}</div>
                        {% if package.is_installed %}
                            <button onclick="uninstall('{{package.shortname}}', '{{package.prettyname}}')">Remove</button>
                        {% else %}
                            <button onclick="install('{{package.shortname}}', '{{package.prettyname}}')">Install</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {# ------------------------------------------------------------------ #}
        {# Addons #}
        {# ------------------------------------------------------------------ #}
        <div id="addons-panel" class="panel area" role="tabpanel">
            {% for package in available_packages.addons %}
            <div class="app{% if package.is_installed %} installed{% endif %}">
                <img class="preview-image" src="{{package.preview_image}}" />
                <div class="info-area">
                    <div class="info">
                        <strong class="name">{{package.prettyname}}</strong>
                        <span class="developer">By <a href="{{package.candidate.homepage}}">{{package.maintainer}}</a></span>
                        <div class="description">{{package.candidate.summary}}</div>
                        {% if package.is_installed %}
                            <button onclick="uninstall('{{package.shortname}}', '{{package.prettyname}}')">Remove</button>
                        {% else %}
                            <button onclick="install('{{package.shortname}}', '{{package.prettyname}}')">Install</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>

</div>
{% endblock %}

{% block end_of_page %}
    <div id="package-progress" style="height: 100%; width: 100%; position: fixed; z-index: 100; display: none;">
        <div style="background-color: white; margin: 15% auto; padding: 20px; max-width: 640px; width: 100%; overflow: auto;">
            <h1>Installing Processing Example</h1>
            

            <ul class="terminal" style="background: #ccc; font-family: monospace; font-weight: lighter; font-size: 12px; height: 100px; overflow: auto; white-space: nowrap; list-style: none; padding: 1rem; line-height: 1.3;">
            </ul>

            <progress value="43" max="100" style="-webkit-appearance: none; appearance: none; width: 100%; height: 1rem; border-radius: 3px; margin: 1rem 0;"></progress>

            <button disabled style="float: right" onclick="location.reload();">OK</button>
        </div>
    </div>
{% endblock %}

{% block page_footer_scripts %}
<script type="text/javascript">

    $(document).ready(function() {
    });

    var showProgress = function(title) {
        TooloopUI.showCover();
        $('#package-progress h1').html(title);
        $('#package-progress .terminal').empty();
        $('#package-progress button').attr('disabled', true);
        $('#package-progress').fadeIn(100);
    }

    var updateProgress = function(event, source) {
        progress = JSON.parse(event.data);
        $('#package-progress .terminal').append('<li>'+progress.task+'</li>');
        $('#package-progress .terminal').scrollTop(99999999999);
        $('#package-progress progress').val(progress.percent)
        if (progress.status.toLowerCase() != 'ok') {
            $('#package-progress button').removeAttr('disabled');
            source.close();
        }
    };

    var install = function(package, prettyname) {
        // show modal
        showProgress("Installing " + prettyname)
        // listen to progress updates
        var source = new EventSource("/tooloop/api/v1.0/appcenter/progress");
        source.onmessage = function(event) { updateProgress(event, source) };
        // install
        $.ajax({
            url: "/tooloop/api/v1.0/appcenter/install/"+package
        }).done(function( data ) {
           // location.reload();
        });
    };


    var uninstall = function(package, prettyname) {
        // show modal
        showProgress("Removing " + prettyname)
        // listen to progress updates
        var source = new EventSource("/tooloop/api/v1.0/appcenter/progress");
        source.onmessage = function(event) { updateProgress(event, source) };
        // uninstall
        $.ajax({
            url: "/tooloop/api/v1.0/appcenter/uninstall/"+package
        }).done(function( data ) {
           // location.reload();
        });
    };

</script>
{% endblock %}
