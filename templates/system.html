{% extends "base.html" %}

{% block content %}
<table class="settings-table">
    <tr>
        <td colspan="2" style="padding: 2em 0; text-align: center;">
            <p><img src="/static/img/tooloop_logo.png" style="width:100%; max-width:240px;"/></p>
            <h1>Tooloop OS</h1>
            <span class="gray">{{osVersion}}</span>
        </td>
    </tr>
    <tr><td colspan="2"><h2>System</h2></td></tr>
    <tr>
        <td class="label-column">Name</td>
        <td class="value-column">
            <form id="hostname-form" style="float: left;">
                <input type="text" id="hostname-input" value="{{hostname}}">
                <button type="submit">Save</button>
            </form>
        </td>
        <tr>
            <td class="label-column">IP address</td>
            <td class="value-column">{{ ip_address }}</td>
        </tr>
    </tr>
    <tr><td colspan="2"><h2>Change password</h2></td></tr>

    <tr>
        <td class="label-column"></td>
        <td class="value-column">
            <form id="password-form">
                <p><input type="password" id="old-password" name="old-password"/> <label for="old-password">Old password</label></p>
                <p><input type="password" id="new-password" name="new-password"/> <label for="new-password">New password</label></p>
                <p><input type="password" id="repeat-new-password" name="repeat-new-password" /> <label for="repeat-new-password">Repeat new password</label></p>
                <button type="submit">Save</button>
            </form>
        </td>
    </tr>

    {% endblock %}


    {% block page_footer_scripts %}

    <script type="text/javascript">

        $('#hostname-form').on('submit', function(event) {
            event.preventDefault();

            var feedback = attachFeedback(event.target);

            $.ajax({
                method: "PUT",
                data: { "hostname":$('#hostname-input').val() },
                url: "/tooloop/api/v1.0/system/hostname"
            }).done(function( data ) {
                displayConfirmFeedback(feedback, data.message);
            }).error(function( jqXHR, textStatus, errorThrown ) {
                displayErrorFeedback(feedback, errorThrown);
            });

        });


        $('#password-form').on('submit', function(event) {
            event.preventDefault();
            var feedback = attachFeedback(event.target);

            var oldPassword = $("#old-password").val();
            var newPassword = $("#new-password").val();
            var repeatNewPassword = $("#repeat-new-password").val();

            if (oldPassword == "" || newPassword == "" || repeatNewPassword == "") {
                displayErrorFeedback(feedback, "Please fill all fields.");
                return;
            }

            if ( newPassword != repeatNewPassword) {
                displayErrorFeedback(feedback, "New passwords donâ€™t match.");
                return;
            }

            $.ajax({
                method: "PUT",
                data: { "oldPassword" : oldPassword, "newPassword": newPassword },
                url: "/tooloop/api/v1.0/system/password"
            }).done(function( data ) {
                console.log(data);
                displayConfirmFeedback(feedback, data.message);
            }).error(function( jqXHR, textStatus, errorThrown ) {
                responseText = $.parseHTML(jqXHR.responseText);

                for (var i=0; i<responseText.length; i++) {
                    if (responseText[i].tagName == 'P') {
                        displayErrorFeedback(feedback, responseText[i].textContent);
                        break;
                    }
                }

            });

        });

    </script>

{% endblock %}